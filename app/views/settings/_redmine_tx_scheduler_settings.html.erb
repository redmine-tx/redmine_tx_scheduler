<fieldset class="box">
  <legend>ë“±ë¡ëœ ìŠ¤ì¼€ì¤„ëŸ¬ ì‘ì—…</legend>
  
  <div style="margin-bottom: 10px;">
    <% 
      migration_error = RedmineScheduler.migration_required?
      registered_tasks = RedmineScheduler.all_tasks_info
    %>
    
    <% if migration_error %>
      <div class="flash error">
        <strong>âš ï¸ ë§ˆì´ê·¸ë ˆì´ì…˜ í•„ìš”</strong><br>
        ìŠ¤ì¼€ì¤„ëŸ¬ í”ŒëŸ¬ê·¸ì¸ í…Œì´ë¸”ì´ ìƒì„±ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.<br>
        ë‹¤ìŒ ëª…ë ¹ì„ ì‹¤í–‰í•˜ì„¸ìš”:<br>
        <code style="background: #f5f5f5; padding: 2px 4px; margin-top: 5px; display: inline-block;">
          bundle exec rake redmine:plugins:migrate NAME=redmine_tx_scheduler RAILS_ENV=<%= Rails.env %>
        </code>
      </div>
    <% elsif registered_tasks.any? %>
      <div class="flash notice">
        <strong><%= registered_tasks.count %>ê°œì˜ ìŠ¤ì¼€ì¤„ëŸ¬ ì‘ì—…ì´ ë“±ë¡ë˜ì–´ ìˆìŠµë‹ˆë‹¤.</strong>
        <% recently_executed = registered_tasks.select { |task| task[:recently_executed] } %>
        <% if recently_executed.any? %>
          (<%= recently_executed.count %>ê°œê°€ ìµœê·¼ì— ì‹¤í–‰ë¨)
        <% end %>
      </div>
    <% else %>
      <div class="flash warning">
        ë“±ë¡ëœ ìŠ¤ì¼€ì¤„ëŸ¬ ì‘ì—…ì´ ì—†ìŠµë‹ˆë‹¤.
      </div>
    <% end %>
  </div>

  <% if registered_tasks.any? && !migration_error %>
    <table class="list" style="margin-top: 15px;">
      <thead>
        <tr>
          <th>ì‘ì—…ëª…</th>
          <th>ì„¤ëª…</th>
          <th>ì‹¤í–‰ ì£¼ê¸°</th>
          <th>ì‹¤í–‰ íšŸìˆ˜</th>
          <th>ë§ˆì§€ë§‰ ì‹¤í–‰</th>
          <th>ìƒíƒœ</th>
          <th>ê´€ë¦¬</th>
        </tr>
      </thead>
      <tbody>
        <% registered_tasks.each do |task| %>
          <tr class="<%= cycle('odd', 'even') %>">
            <td>
              <strong><%= task[:name] %></strong>
            </td>
            <td>
              <%= task[:description] || task[:name] %>
            </td>
            <td class="center">
              <% if task[:schedule_type] == 'cron' %>
                <span class="badge" style="background-color: #4CAF50; color: white; padding: 2px 6px; border-radius: 3px;">
                  <%= task[:cron_human_readable] || task[:cron_expression] %>
                </span>
                <br>
                <small style="color: #666;">
                  cron: <%= task[:cron_expression] %>
                </small>
              <% else %>
                <span class="badge" style="background-color: #9C27B0; color: white; padding: 2px 6px; border-radius: 3px;">
                  <%= task[:period_in_words] || "5ë¶„" %>
                </span>
                <br>
                <small style="color: #666;">
                  (<%= task[:period_seconds] || 300 %>ì´ˆ)
                </small>
              <% end %>
            </td>
            <td class="center">
              <span class="badge" style="background-color: #FF9800; color: white; padding: 2px 6px; border-radius: 3px;">
                <%= task[:execution_count] %>íšŒ
              </span>
            </td>
            <td>
              <% if task[:last_executed_at] %>
                <% last_execution_at = task[:last_executed_at].is_a?(Time) ? task[:last_executed_at] : Time.parse(task[:last_executed_at].to_s) %>
                <%= format_time(last_execution_at) %>
                <br>
                <small style="color: #666;">
                  <%= time_ago_in_words(last_execution_at) %> ì „
                </small>
              <% else %>
                <span style="color: #999;">ì•„ì§ ì‹¤í–‰ë˜ì§€ ì•ŠìŒ</span>
              <% end %>
            </td>
            <td class="center">
              <% if task[:recently_executed] %>
                <span style="color: #4CAF50; font-weight: bold;">
                  â— ìµœê·¼ ì‹¤í–‰ë¨
                </span>
                <br>
                <small style="color: #666;">ì£¼ê¸° ë‚´</small>
              <% else %>
                <span style="color: #666; font-weight: bold;">
                  â— ëŒ€ê¸°ì¤‘
                </span>
                <br>
                <% if task[:next_executable_at] %>
                  <% next_exec = task[:next_executable_at].is_a?(Time) ? task[:next_executable_at] : Time.parse(task[:next_executable_at].to_s) %>
                  <small style="color: #666;">
                    <%= time_ago_in_words(next_exec) %> í›„ ì‹¤í–‰ ê°€ëŠ¥
                  </small>
                <% else %>
                  <small style="color: #666;">ì¦‰ì‹œ ì‹¤í–‰ ê°€ëŠ¥</small>
                <% end %>
              <% end %>
            </td>
            <td class="center">
              <button type="button" onclick="executeTask('<%= task[:name] %>');" class="button-small" style="background-color: #2196F3; color: white; border: none; padding: 4px 8px; border-radius: 3px; cursor: pointer; font-size: 11px;">
                â–¶ ì§€ê¸ˆ ì‹¤í–‰
              </button>
            </td>
          </tr>
        <% end %>
      </tbody>
    </table>

    <div style="margin-top: 15px; padding: 10px; background-color: #f5f5f5; border-radius: 5px;">
      <h4 style="margin-top: 0;">ì‘ì—… í†µê³„</h4>
      <div class="flex-container" style="display: flex; gap: 20px; flex-wrap: wrap;">
        <div class="stat-item" style="background: white; padding: 10px; border-radius: 5px; flex: 1; min-width: 150px;">
          <div style="font-size: 24px; font-weight: bold; color: #4CAF50;"><%= registered_tasks.count %></div>
          <div style="color: #666; font-size: 12px;">ë“±ë¡ëœ ì‘ì—…</div>
        </div>
        <div class="stat-item" style="background: white; padding: 10px; border-radius: 5px; flex: 1; min-width: 150px;">
          <div style="font-size: 24px; font-weight: bold; color: #FF9800;"><%= registered_tasks.sum { |task| task[:execution_count] || 0 } %></div>
          <div style="color: #666; font-size: 12px;">ì´ ì‹¤í–‰ íšŸìˆ˜</div>
        </div>
        <div class="stat-item" style="background: white; padding: 10px; border-radius: 5px; flex: 1; min-width: 150px;">
          <div style="font-size: 24px; font-weight: bold; color: #2196F3;">
            <% recently_executed_count = registered_tasks.count { |task| task[:recently_executed] } %>
            <%= recently_executed_count %>
          </div>
          <div style="color: #666; font-size: 12px;">ìµœê·¼ ì‹¤í–‰ëœ ì‘ì—…</div>
        </div>
        <div class="stat-item" style="background: white; padding: 10px; border-radius: 5px; flex: 1; min-width: 150px;">
          <div style="font-size: 24px; font-weight: bold; color: #9C27B0;">
            <% executed_tasks = registered_tasks.select { |task| task[:last_executed_at] } %>
            <% if executed_tasks.any? %>
              <% last_execution = executed_tasks.map { |task| task[:last_executed_at] }.max %>
              <% last_execution = last_execution.is_a?(Time) ? last_execution : Time.parse(last_execution.to_s) %>
              <%= time_ago_in_words(last_execution) %> ì „
            <% else %>
              ì—†ìŒ
            <% end %>
          </div>
          <div style="color: #666; font-size: 12px;">ë§ˆì§€ë§‰ ì‹¤í–‰</div>
        </div>
      </div>
    </div>

    <div style="margin-top: 15px; text-align: right;">
      <button type="button" onclick="location.reload();" class="button-small" style="background-color: #2196F3; color: white; border: none; padding: 5px 10px; border-radius: 3px; cursor: pointer;">
        ğŸ”„ ìƒˆë¡œê³ ì¹¨
      </button>
    </div>
  <% end %>

  <!-- API í…ŒìŠ¤íŠ¸ ì„¹ì…˜ ì¶”ê°€ -->
  <% if registered_tasks.any? && !migration_error %>
    <div style="margin-top: 20px; padding: 10px; background-color: #f0f8ff; border-radius: 5px; border-left: 4px solid #2196F3;">
      <h4 style="margin-top: 0; color: #2196F3;">âš™ï¸ API í…ŒìŠ¤íŠ¸</h4>
      <p style="margin: 5px 0; color: #666; font-size: 14px;">
        ìŠ¤ì¼€ì¤„ëŸ¬ APIë¥¼ ìˆ˜ë™ìœ¼ë¡œ í…ŒìŠ¤íŠ¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤ (ì™¸ë¶€ cron í˜¸ì¶œê³¼ ë™ì¼).
      </p>
      <div style="margin-top: 10px;">
        <button type="button" onclick="testPingAPI();" style="background-color: #4CAF50; color: white; border: none; padding: 8px 15px; border-radius: 3px; cursor: pointer; margin-right: 10px;">
          ğŸ“¡ Ping í…ŒìŠ¤íŠ¸
        </button>
        <button type="button" onclick="testStatusAPI();" style="background-color: #FF9800; color: white; border: none; padding: 8px 15px; border-radius: 3px; cursor: pointer;">
          ğŸ“Š ìƒíƒœ ì¡°íšŒ
        </button>
      </div>
      <div id="api-test-result" style="margin-top: 10px; padding: 10px; background-color: white; border-radius: 3px; display: none;">
        <strong>í…ŒìŠ¤íŠ¸ ê²°ê³¼:</strong>
        <pre id="api-result-content" style="margin: 5px 0; font-size: 12px; color: #333; white-space: pre-wrap;"></pre>
      </div>
    </div>
  <% end %>
</fieldset>

<fieldset class="box" style="margin-top: 20px;">
  <legend>ìŠ¤ì¼€ì¤„ëŸ¬ ì„¤ì •</legend>
  
  <div style="padding: 15px;">
    <label style="display: flex; align-items: center; gap: 8px;">
      <%= check_box_tag 'settings[tx_scheduler_disabled]', '1', Setting.plugin_redmine_tx_scheduler['tx_scheduler_disabled'] %>
      <span>ìŠ¤ì¼€ì¤„ëŸ¬ ë¹„í™œì„±í™”</span>
      <small style="color: #666; margin-left: 10px;">
        (ì²´í¬í•˜ë©´ ëª¨ë“  ìŠ¤ì¼€ì¤„ëŸ¬ ì‘ì—…ì´ ì¤‘ì§€ë©ë‹ˆë‹¤)
      </small>
    </label>
  </div>
</fieldset>

<script>
// API í…ŒìŠ¤íŠ¸ í•¨ìˆ˜ë“¤
function testPingAPI() {
  const resultDiv = document.getElementById('api-test-result');
  const contentPre = document.getElementById('api-result-content');
  
  resultDiv.style.display = 'block';
  contentPre.textContent = 'í…ŒìŠ¤íŠ¸ ì¤‘...';
  
  fetch('/scheduler/ping', {
    method: 'GET',
    headers: {
      'Content-Type': 'application/json'
    }
  })
  .then(response => response.json())
  .then(data => {
    contentPre.textContent = JSON.stringify(data, null, 2);
    if (data.success) {
      resultDiv.style.borderLeft = '4px solid #4CAF50';
    } else {
      resultDiv.style.borderLeft = '4px solid #f44336';
    }
    // ì„±ê³µì‹œ í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨ (í†µê³„ ì—…ë°ì´íŠ¸)
    if (data.success) {
      setTimeout(() => location.reload(), 2000);
    }
  })
  .catch(error => {
    contentPre.textContent = 'Error: ' + error.message;
    resultDiv.style.borderLeft = '4px solid #f44336';
  });
}

function testStatusAPI() {
  const resultDiv = document.getElementById('api-test-result');
  const contentPre = document.getElementById('api-result-content');
  
  resultDiv.style.display = 'block';
  contentPre.textContent = 'ì¡°íšŒ ì¤‘...';
  
  fetch('/scheduler/status', {
    method: 'GET',
    headers: {
      'Content-Type': 'application/json'
    }
  })
  .then(response => response.json())
  .then(data => {
    contentPre.textContent = JSON.stringify(data, null, 2);
    if (data.success) {
      resultDiv.style.borderLeft = '4px solid #4CAF50';
    } else {
      resultDiv.style.borderLeft = '4px solid #f44336';
    }
  })
  .catch(error => {
    contentPre.textContent = 'Error: ' + error.message;
    resultDiv.style.borderLeft = '4px solid #f44336';
  });
}

function executeTask(taskName) {
  if (!confirm('\'' + taskName + '\' ì‘ì—…ì„ ì§€ê¸ˆ ì‹¤í–‰í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
    return;
  }

  const resultDiv = document.getElementById('api-test-result');
  const contentPre = document.getElementById('api-result-content');
  
  // API ê²°ê³¼ ì˜ì—­ì´ ìˆ¨ê²¨ì ¸ ìˆì„ ìˆ˜ ìˆìœ¼ë¯€ë¡œ í‘œì‹œ
  if (resultDiv) {
    resultDiv.style.display = 'block';
    contentPre.textContent = taskName + ' ì‹¤í–‰ ìš”ì²­ ì¤‘...';
    // ìŠ¤í¬ë¡¤ ì´ë™
    resultDiv.scrollIntoView({ behavior: 'smooth' });
  }

  const csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content');
  const headers = {
    'Content-Type': 'application/json'
  };
  if (csrfToken) {
    headers['X-CSRF-Token'] = csrfToken;
  }

  fetch('/scheduler/execute/' + encodeURIComponent(taskName), {
    method: 'POST',
    headers: headers,
    body: JSON.stringify({ force: true })
  })
  .then(response => response.json())
  .then(data => {
    if (resultDiv && contentPre) {
      contentPre.textContent = JSON.stringify(data, null, 2);
      if (data.success) {
        resultDiv.style.borderLeft = '4px solid #4CAF50';
      } else {
        resultDiv.style.borderLeft = '4px solid #f44336';
      }
    } else {
      alert(data.success ? 'ì‹¤í–‰ ì„±ê³µ' : 'ì‹¤í–‰ ì‹¤íŒ¨: ' + data.message);
    }
    
    // ì„±ê³µì‹œ í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨
    if (data.success) {
      setTimeout(() => location.reload(), 2000);
    }
  })
  .catch(error => {
    const errorMsg = 'Error: ' + error.message;
    if (resultDiv && contentPre) {
      contentPre.textContent = errorMsg;
      resultDiv.style.borderLeft = '4px solid #f44336';
    } else {
      alert(errorMsg);
    }
  });
}


// ìë™ ìƒˆë¡œê³ ì¹¨ (60ì´ˆë§ˆë‹¤, ping API ë°©ì‹ì—ì„œëŠ” ìì£¼ ìƒˆë¡œê³ ì¹¨í•  í•„ìš” ì—†ìŒ)
setInterval(function() {
  if (document.getElementById('tab-redmine_tx_scheduler') && 
      document.getElementById('tab-redmine_tx_scheduler').classList.contains('selected')) {
    // í˜„ì¬ íƒ­ì´ í™œì„±í™”ëœ ê²½ìš°ì—ë§Œ ìƒˆë¡œê³ ì¹¨
    location.reload();
  }
}, 60000);
</script>

<style>
.badge {
  display: inline-block;
  font-size: 11px;
  font-weight: bold;
  text-align: center;
  white-space: nowrap;
  vertical-align: baseline;
}

.stat-item {
  box-shadow: 0 1px 3px rgba(0,0,0,0.1);
  transition: transform 0.2s;
}

.stat-item:hover {
  transform: translateY(-2px);
}

/* API í…ŒìŠ¤íŠ¸ ì„¹ì…˜ ìŠ¤íƒ€ì¼ */
#api-test-result {
  border: 1px solid #ddd;
  transition: border-left 0.3s ease;
}

#api-test-result pre {
  max-height: 200px;
  overflow-y: auto;
  background-color: #f8f9fa;
  padding: 8px;
  border-radius: 3px;
  border: 1px solid #e9ecef;
}

/* ë°˜ì‘í˜• ë””ìì¸ */
@media (max-width: 768px) {
  .flex-container {
    flex-direction: column;
  }
  
  table.list {
    font-size: 12px;
  }
  
  table.list th, table.list td {
    padding: 5px 3px;
  }
  
  /* ëª¨ë°”ì¼ì—ì„œ API í…ŒìŠ¤íŠ¸ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
  button {
    width: 100%;
    margin-bottom: 5px;
  }
}
</style>
